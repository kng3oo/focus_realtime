<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>실시간 집중도 모니터링</title>
  <style>
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      margin:0;
      padding:24px;
      background:#f5f5f5;
    }
    h1{margin-top:0;}
    .layout{
      display:grid;
      grid-template-columns:3fr 1.2fr;
      gap:16px;
      margin-top:16px;
    }
    .card{
      background:#fff;
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    #videoBox{
      width:100%;
      border-radius:16px;
      overflow:hidden;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    #video{
      width:100%;
      display:block;
      object-fit:contain;
    }
    .label{font-weight:600;margin-right:4px;}
    .gauge{
      margin-top:8px;
      width:100%;
      height:18px;
      background:#ddd;
      border-radius:9px;
      overflow:hidden;
    }
    .gauge-inner{
      height:100%;
      width:0%;
      background:#2f80ed;
      transition:width .2s;
    }
    .rank-item{
      background:#111;
      color:#0f0;
      padding:4px 8px;
      border-radius:8px;
      margin-top:4px;
      font-size:14px;
    }
    button{
      border:none;
      border-radius:6px;
      padding:6px 12px;
      background:#2f80ed;
      color:#fff;
      cursor:pointer;
      margin-left:4px;
    }
    button:disabled{
      background:#bbb;
      cursor:default;
    }
    input{
      padding:6px 8px;
      border-radius:4px;
      border:1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>실시간 집중도 모니터링</h1>

  <div>
    <span class="label">사용자 이름:</span>
    <input id="userName" value="김강우"/>
    <button id="btnStart">시작</button>
    <button id="btnStop" disabled>정지</button>
  </div>

  <p id="userDisplay">사용자: -</p>

  <div class="layout">
    <div class="card">
      <div id="videoBox">
        <img id="video" alt="video stream"/>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>실시간 집중도</h3>
        <p>현재: <span id="focusNow">0.00</span></p>
        <p>10초 평균: <span id="focus10s">0.00</span></p>
        <p>1분 평균: <span id="focus1m">0.00</span></p>
        <p>10분 평균: <span id="focus10m">0.00</span></p>
        <div class="gauge">
          <div id="focusGauge" class="gauge-inner"></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>감정 빈도 랭킹</h3>
        <div id="rankList">
          <div class="rank-item">데이터 없음</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>로그</h3>
        <button id="btnDownload">CSV 다운로드</button>
      </div>
    </div>
  </div>

<script>
let ws = null;

function connect() {
  if (ws) return;
  const url = `ws://${location.host}/ws/video`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    console.log("WS open");
    document.getElementById("btnStart").disabled = true;
    document.getElementById("btnStop").disabled = false;
  };

  ws.onclose = () => {
    console.log("WS closed");
    ws = null;
    document.getElementById("btnStart").disabled = false;
    document.getElementById("btnStop").disabled = true;
  };

  ws.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);

      // 이미지
      if (data.frame) {
        const img = document.getElementById("video");
        img.src = "data:image/jpeg;base64," + data.frame;
      }

      // 집중도
      const f = data.focus ?? 0;
      document.getElementById("focusNow").innerText = f.toFixed(2);
      document.getElementById("focus10s").innerText = (data.avg_10s ?? 0).toFixed(2);
      document.getElementById("focus1m").innerText  = (data.avg_1m ?? 0).toFixed(2);
      document.getElementById("focus10m").innerText = (data.avg_10m ?? 0).toFixed(2);

      const gauge = document.getElementById("focusGauge");
      gauge.style.width = (Math.max(0, Math.min(1, f)) * 100).toFixed(0) + "%";

      // 감정 랭킹
      const rankDiv = document.getElementById("rankList");
      rankDiv.innerHTML = "";
      const rank = data.emotion_rank || [];
      if (rank.length === 0) {
        const el = document.createElement("div");
        el.className = "rank-item";
        el.innerText = "데이터 없음";
        rankDiv.appendChild(el);
      } else {
        rank.forEach(([label, cnt]) => {
          const el = document.createElement("div");
          el.className = "rank-item";
          el.innerText = `${label}: ${cnt}`;
          rankDiv.appendChild(el);
        });
      }
    } catch (e) {
      console.error("WS message parse error", e);
    }
  };
}

document.getElementById("btnStart").addEventListener("click", () => {
  const name = (document.getElementById("userName").value || "").trim();
  document.getElementById("userDisplay").innerText = "사용자: " + (name || "-");
  connect();
});

document.getElementById("btnStop").addEventListener("click", () => {
  if (ws) {
    ws.close();
    // 화면/값 초기화는 선택
    // document.getElementById("video").src = "";
  }
});

document.getElementById("btnDownload").addEventListener("click", () => {
  window.location.href = "/api/download_log";
});
</script>
</body>
</html>
